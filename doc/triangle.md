# 動作

三角波チャンネルは以下の32段階4bitの値が循環して出力されることで三角波を表現する

```
15, 14, 13, 12, 11, 10,  9,  8,  7,  6,  5,  4,  3,  2,  1,  0,
0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15
```

ボリュームコントロールはなく、波形は循環しているか中断(同じ値が出力され続ける)している

同じ値が出力され続けると波形が出来ず音は聞こえなくなる

三角波の段階をリセットする方法はない

# 構成

三角波チャンネルは以下のユニットで構成されている

- タイマー
- 長さカウンタ
- リニアカウンタ
- リニアカウンタリロードフラグ
- コントロールフラグ
- シーケンサ

```text
      Linear Counter   Length Counter
            |                |
            v                v
Timer ---> Gate ----------> Gate ---> Sequencer ---> (to mixer)
```

リニアカウンタは長さカウンタより精度の高い継続時間タイマーである

タイマーがクロックを生成し、線形カウンタと長さカウンタが両方とも0でなければシーケンサを励起する

シーケンサが励起されなければ、出力は一定の値になり、三角波は中断される

常に0を出力し続けることでミュートするパルスチャンネルとは違い、三角波チャンネルは最後の出力を繰り返し続けることでミュートする

# レジスタ

## $4008 Linear counter setup (write)

CRRR RRRR

C: コントロールフラグ 

このビットは長さカウンタのhaltフラグも兼ねていて、線形カウンタと長さカウンタを同時に制御する

- このビットがセットされた時、パルスチャンネルやノイズチャンネルと同じ方法で長さカウンタを停止させる
- このビットがセットされた時、線形カウンタの内部のリロードフラグがクリアされるのを防ぐ。この後に$400Bに書き込めば効率的に停止出来る
- 線形カウンタは一定期間の後にチャンネルをミュートする
- 線形カウンタも長さカウンタも同時に有効化されるので、どちらか長い設定を持つほうが冗長である

R: カウンターのリロード値

この値は次のフレームカウンタのクロックで反映される(リロードフラグがセットされていれば)

- $400Bへの書き込みはリロードフラグをセットさせる
- リロード値を適用したクロックの後、Cがクリアされていれば、リロードフラグもクリアされる(リロードしたクロックではされないということか？) \
  そうでない場合、リロードし続ける(つまり停止する)

## $400A タイマーの low ビット (write)

LLLL LLLL

L: タイマーの low 8 bits

## $400B 長さカウンタのロード値、タイマーの high ビット (write)

llll lHHH \
l: Length counter load \
H: Timer high 3 bits

Side effects: リニアカウンタのリロードフラグをセットする 

# クロック

シーケンサーは11bitの周期を持つタイマーによってクロックされる

タイマーは周期をtとすると t, t-1, t-2, ..., 0 とカウントダウンされ、再びtをロードする

つまり、タイマーがt+1回クロックしたらシーケンサが1回クロックされる

パルスチャンネルと異なり、このタイマーはAPU(CPU/2)ではなく、CPUの周期でクロックされる

また、タイマーが許しうる限りの最大周波数をサポートしているのも特徴(周波数が一定以上超えてもミュートしない)

可聴範囲をはるかに超えているので、エミュレーターではタイマーの値が2を下回ったらチャンネルを停止すれば良い

フレームカウンタがリニアカウンタをクロックする時、以下のアクションが順に起きる

1. もしリニアカウンタのリロードフラグがセットされていたら、リニアカウンタは値をリロードする。そうでなく、カウンタが0でなければデクリメントされる
2. コントロールフラグがクリアされていたら、リニアカウンタのリロードフラグがクリアされる

リロードフラグはコントロールフラグがクリアされない限り、クリアされないことに注意

両方がセットされている時の$4008への値の書き込みは、次のリニアカウンターのクロックでリロードされる

シーケンサはリニアカウンタと長さカウンタが両方とも0でない時にタイマーによってクロックされる

シーケンサは以下のループする32ステップの値をミキサに送る

ミキサ内では、DMCレベルが三角波のレベルに顕著に影響を与える

# ミュート方法

## 1. 線形カウンタを継続的に0にする
  
$4008に$80を書き込む

これにより、次のフレームカウンタによるクロックで、線形カウンタは0にリロードされる

次のフレームカウンタのクロック(1/4フレームの遅延)まで待てない場合、$4008に書き込んだ後に$4017に書き込んでフレームカウンタのクロックを励起させることが出来る

しかし、これはフレームカウンタにクロックされる他のすべてのユニットにも影響を与えることに注意

再開するには単に$4008に$FFを書き込めば良い

この方法を使ってミュートする場合、コントロールフラグとリロードフラグは永続的にセットされなければならない \
(これにより線形カウンタは常にリロードし続けるので、$4008でリロード値を変えれば反映されて再開出来る)

## 2. 長さカウンタを停止させる

$4015で三角波チャンネルのビットをクリアして三角波チャンネルの長さカウンタを停止させる

再開するには$4015で再び長さカウンタをオンにしてから$400Bに書き込んで長さカウンタに値をロードする

DPCMサンプルを使っている時は、DPCMコントロールとの競合なく、$4015の一つのビットを操作するのは難しいだろう

## 3. 三角波チャンネルのタイマー周期を極端に小さくする

$400A/$400Bで、周期の値を0か1で設定すると非常に高い周波数になり、人間の可聴範囲を超える

ローパスフィルターの平均化の効果によって結果の値は7.5に固定されるが、この時、激しい破裂音が生じる

ロックマン1,2ではこの手法を使っている


# その他

三角波チャンネルのピッチは同じタイマー値を持つパルスチャンネルの1オクターブ下である


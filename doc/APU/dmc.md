# 構成

DMCチャンネルは以下のユニットで構成されている

- Memory reader (Remaining bytes)
- Sample buffer
- Shifter (Remaining bits)
- Timer
- Output level(up and down counter)

```text
                         Timer
                           |
                           v
Reader ---> Buffer ---> Shifter ---> Output level ---> (to the mixer)
```

## ざっくりとしたフロー

1. サンプルが格納されているアドレスとその長さが設定される

2. メモリリーダが1バイトずつバッファに読み込む

3. タイマーによって励起された Shifter により、1ビットずつ処理される。この処理により Output level の値が変化する \
   処理が終わるとバッファを空にする(そしてメモリリーダが次のバイトを読み込む)

4. Output level は起動時に0でロードされ、Shifter により更新される \
   それ以外にも$4011への書き込みで直接値を設定することも出来る \
   Output level は 7bit の値であり、チャンネルが有効か無効かに関わらずミキサに送られる
   
# Buffer

サンプルバッファは 8bit 幅であり、再生すべきサンプルの1バイトを保持しているか、空である

バッファはメモリリーダによって埋められ、Shifter によって空にされる

# Memory reader

サンプルバッファが空になるとメモリリーダは現在再生しているサンプルの次のバイトで埋める

メモリリーダはアドレスカウンタと残りバイト数カウンタを持っている

サンプルの再生が始まる時、アドレスカウンタがそのサンプルにアドレスに設定されて、残りバイト数はサンプルの長さに設定される

残りバイト数カウンタが0でなく、サンプルバッファが空の時($4015への書き込み直後も含む)は、以下のことが起こる

- サンプルバイトを読むため、CPUが1～4サイクルストールする。厳密なサイクル数は多くの要素に依る
- サンプルバッファが次の現在のアドレスから読み取られた次のサンプルのバイトで満たされる
- アドレスがインクリメントされる。もし$FFFFを超える場合、$8000に戻る
- 残りバイト数カウンタがデクリメントされる。0になってループフラグがセットされている場合、サンプルがリスタートする。\
  セットされていなくて IRQ enabled フラグがセットされている場合、Interrupt flag がセットされる

Interrupt flag がセットされている時はいつでも、CPUのIRQラインはフラグがクリアされるまで継続的にアサートする。プロセッサはストールしたところから再開する(？)

# Shifter

Shifter は残りビット数カウンタとシフトレジスタ、サイレンスフラグ(?)を持っている

APU cycle でタイマーがクロックされる

タイマーがクロックを出力する時、次のことが順に起こる

1. サイレンスフラグがクリアなら出力レベルがシフトレジスタのbit0によって変わる。1ならば2を足す、0ならば2を引く。 \
   ただし、加算/減算によって出力レベルが0~127の範囲を出る場合は、出力レベルは変更されない \
   これはつまり、現在のレベルが減算なら最低でも2、加算なら最高でも125まででないと変更されない
2. シフトレジスタが右に1つシフトされる
3. 残りビット数カウンタがデクリメントされる。もし0になったら新しい出力サイクルが始まる \
   残りビット数カウンタは、現在サンプルを再生しているかどうかに関わらず、タイマーがクロックを出力した時は常に更新される

このサイクルは中断できない。すべてのサイクルは新しいサイクルが始まる前に完了しなければならない

出力サイクルが終わった時、新しいサイクルが以下のように始まる

1. 残りビット数カウンタが8でロードされる
2. もしサンプルバッファが空なら、サイレンスフラグがセットされる。そうでなければ、サイレンスフラグはクリアされ、サンプルバッファはシフトレジスタに移され空になる

# CPUのストール

ちゃんと処理しないとズレとか出てくんのかな

# 関連レジスタ

## $4015 Status (write)

---D NT21 \
D: DMC \
N: Noise \
T: Triangle \
2: Pulse2 \
1: Pulse1

- DMC フラグがクリアされると、DMCの残りバイト数は0にセットされ、DMCはミュートになる
- DMC フラグがセットされると、DMCサンプルは残っているバイトが0の場合にのみリスタートする(リスタートとは？)(残りバイト数が0でない場合は？) \
  1バイトサンプルバッファに残っているビットがあったら、これらは次のサンプルがフェッチされる前に再生される
- このレジスタへの書き込みはDMC割り込みフラグをクリアする

リスタート = sample_addr と sample_length をセットし直せば良い？
残りバイト数が0でない場合は、単に再開する？

## $4015 Status (Read)

IF-D NT21 \
I: DMC interrupt \
F: Frame interrupt \
D: DMC active \
NT21: Length counter > 0

Dは残りのバイトが1以上であれば1を返す
